<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.icent.isaver.admin.dao.CriticalDetectDao">


    <!--
        임계치별 감지장치 상세를 가져온다.
        @author psb
    -->
    <select id="findByCriticalDetect" resultType="CriticalDetectBean" parameterType="map">
        SELECT  a.critical_detect_id as criticalDetectId
                , a.critical_id as criticalId
                , a.detect_device_id as detectDeviceId
                , a.fence_id as fenceId
                , (SELECT device_name FROM isaver.device WHERE device_id = a.detect_device_id) as detectDeviceName
                , c.event_id as eventId
                , c.event_name as eventName
                , b.critical_level as criticalLevel
        FROM	isaver.critical_detect a
        INNER JOIN isaver.critical b
        ON	    a.critical_id = b.critical_id
        INNER JOIN isaver.event c
        ON	    b.event_id = c.event_id
        WHERE	a.critical_detect_id = #{criticalDetectId}
    </select>

    <!--
        임계치별 감지장치 중복 체크
        @author psb
    -->
    <select id="findExistCriticalDetect" resultType="CriticalDetectBean" parameterType="map">
        SELECT  a.critical_detect_id as criticalDetectId
        FROM	isaver.critical_detect a
        INNER JOIN isaver.critical b
        ON	    a.critical_id = b.critical_id
        WHERE	b.event_id = #{eventId}
        AND	    a.detect_device_id = #{detectDeviceId}
        <if test="fenceId != null and fenceId != ''">
            AND	    a.fence_id = #{fenceId}
        </if>
    </select>

    <!--
        임계치별 감지장치를 등록한다
        @author psb
    -->
    <insert id="addCriticalDetect" parameterType="map">
        INSERT INTO isaver.critical_detect (
            critical_detect_id
            , critical_id
            , detect_device_id
            <if test="fenceId != null and fenceId != ''">
                , fence_id
            </if>
        ) VALUES (
            #{criticalDetectId}
            , #{criticalId}
            , #{detectDeviceId}
            <if test="fenceId != null and fenceId != ''">
                , #{fenceId}
            </if>
        );
    </insert>

    <!--
        임계치별 감지장치를 수정한다.
        @author psb
    -->
    <update id="saveCriticalDetect" parameterType="map" >
        UPDATE  isaver.critical_detect
        SET     detect_device_id = #{detectDeviceId}
                <if test="fenceId != null and fenceId != ''">
                    , fence_id = #{fenceId}
                </if>
        WHERE   critical_detect_id = #{criticalDetectId}
    </update>

    <!--
        임계치별 감지장치를 제거한다
        @author psb
    -->
    <delete id="removeCriticalDetect" parameterType="map">
        DELETE FROM isaver.critical_target WHERE critical_detect_id = #{criticalDetectId};
        DELETE FROM isaver.critical_detect WHERE critical_detect_id = #{criticalDetectId};
    </delete>
</mapper>